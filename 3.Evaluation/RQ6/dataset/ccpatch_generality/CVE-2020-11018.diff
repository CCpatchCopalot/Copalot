diff --git a/channels/cliprdr/server/cliprdr_main.c b/channels/cliprdr/server/cliprdr_main.c
index 8854a0fb7..79f7baa9d 100644
--- a/channels/cliprdr/server/cliprdr_main.c
+++ b/channels/cliprdr/server/cliprdr_main.c
@@ -464,7 +464,7 @@ static UINT cliprdr_server_receive_capabilities(CliprdrServerContext* context, w
 	UINT16 index;
 	UINT16 capabilitySetType;
 	UINT16 capabilitySetLength;
-	UINT error = CHANNEL_RC_OK;
+	UINT error = ERROR_INVALID_DATA;
 	size_t cap_sets_size = 0;
 	CLIPRDR_CAPABILITIES capabilities;
 	CLIPRDR_CAPABILITY_SET* capSet;
@@ -474,6 +474,9 @@ static UINT cliprdr_server_receive_capabilities(CliprdrServerContext* context, w
 	WINPR_UNUSED(header);
 
 	WLog_DBG(TAG, "CliprdrClientCapabilities");
+	if (Stream_GetRemainingLength(s) < 4)
+		return ERROR_INVALID_DATA;
+
 	Stream_Read_UINT16(s, capabilities.cCapabilitiesSets); /* cCapabilitiesSets (2 bytes) */
 	Stream_Seek_UINT16(s);                                 /* pad1 (2 bytes) */
 
@@ -481,6 +484,9 @@ static UINT cliprdr_server_receive_capabilities(CliprdrServerContext* context, w
 	{
 		void* tmp = NULL;
 
+		if (Stream_GetRemainingLength(s) < 4)
+			goto out;
+
 		Stream_Read_UINT16(s, capabilitySetType);   /* capabilitySetType (2 bytes) */
 		Stream_Read_UINT16(s, capabilitySetLength); /* capabilitySetLength (2 bytes) */
 
@@ -530,6 +536,7 @@ static UINT cliprdr_server_receive_capabilities(CliprdrServerContext* context, w
 		}
 	}
 
+	error = CHANNEL_RC_OK;
 	IFCALLRET(context->ClientCapabilities, error, context, &capabilities);
 out:
 	free(capabilities.capabilitySets);