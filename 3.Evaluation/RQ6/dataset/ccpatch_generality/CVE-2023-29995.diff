diff --git a/src/sp/protocol/mqtt/mqtt_parser.c b/src/sp/protocol/mqtt/mqtt_parser.c
--- a/src/sp/protocol/mqtt/mqtt_parser.c
+++ b/src/sp/protocol/mqtt/mqtt_parser.c
@@ -211,7 +211,7 @@
  * @brief safe copy limit size of src data to dest
  * \t  return null and -1 strlen if buffer overflow
  * @param src 
- * @param pos 
+ * @param pos the index cursor of processed packet, will be moved
  * @param str_len target size of data
  * @param limit max size of data copied
  * @return uint8_t* NULL if overflow or not utf-8
@@ -673,7 +673,7 @@
 				if ((rv = check_properties(
 				         cparam->will_properties)) !=
 				    SUCCESS) {
-					return rv;
+					return PROTOCOL_ERROR;
 				}
 			}
 		}
@@ -687,25 +687,23 @@
 		}
 		log_trace("will_topic: %s %d", cparam->will_topic.body, rv);
 		// will msg
-		if (rv == 0) {
-			if (cparam->payload_format_indicator == 0) {
-				cparam->will_msg.body = (char *) copyn_str(
-				    packet, &pos, &len_of_str, max - pos);
-			} else if (rv == 0 &&
-			    cparam->payload_format_indicator == 0x01) {
-				cparam->will_msg.body =
-				    (char *) copyn_utf8_str(
-				        packet, &pos, &len_of_str, max - pos);
-			}
-			cparam->will_msg.len = len_of_str;
-			rv = len_of_str <= 0 ? PAYLOAD_FORMAT_INVALID : 0;
-			log_trace(
-			    "will_msg: %s %d", cparam->will_msg.body, rv);
+		if (rv == 0 && cparam->payload_format_indicator == 0) {
+			cparam->will_msg.body = (char *) copyn_str(
+			    packet, &pos, &len_of_str, max - pos);
+		} else if (rv == 0 &&
+		    cparam->payload_format_indicator == 0x01) {
+			cparam->will_msg.body = (char *) copyn_utf8_str(
+			    packet, &pos, &len_of_str, max - pos);
+		}
+		rv = len_of_str <= 0 ? PAYLOAD_FORMAT_INVALID : 0;
+		if (cparam->will_msg.body == NULL || rv != 0) {
+			return PROTOCOL_ERROR;
 		}
+		cparam->will_msg.len = len_of_str;
 	}
 
 	// username
 	if (rv == 0 && (cparam->con_flag & 0x80) > 0) {
 		cparam->username.body = (char *) copyn_utf8_str(
-		    packet, &pos, &len_of_str, max - pos);
 		cparam->username.len = len_of_str;
 		rv = len_of_str <= 0 ? 1 : 0;
 		if (cparam->username.body == NULL || rv != 0) {
