diff --git a/src/dns.c b/src/dns.c
index c2b0700659..42a3b209bd 100644
--- a/src/dns.c
+++ b/src/dns.c
@@ -274,6 +274,10 @@ static int _dns_encode_domain(struct dns_context *context, const char *domain)
 		total_len++;
 		if (dict_offset >= 0) {
 			int offset = 0xc000 | dict_offset;
+			if (_dns_left_len(context) < 2) {
+				return -1;
+			}
+
 			_dns_write_short(&ptr_num, offset);
 			context->ptr++;
 			ptr_num = NULL;
@@ -295,6 +299,10 @@ static int _dns_encode_domain(struct dns_context *context, const char *domain)
 		domain++;
 	}
 
+	if (_dns_left_len(context) < 1) {
+		return -1;
+	}
+
 	*ptr_num = num;
 
 	if (total_len > 1) {