diff --git a/winpr/libwinpr/sspi/NTLM/ntlm_message.c b/winpr/libwinpr/sspi/NTLM/ntlm_message.c
--- a/winpr/libwinpr/sspi/NTLM/ntlm_message.c
+++ b/winpr/libwinpr/sspi/NTLM/ntlm_message.c
@@ -459,14 +459,14 @@
 	}
 
 	length = (PayloadOffset - StartOffset) + message->TargetName.Len + message->TargetInfo.Len;
+	if (length > buffer->cbBuffer)
+		goto fail;
 
 	if (!sspi_SecBufferAlloc(&context->ChallengeMessage, length))
 		goto fail;
 
-	CopyMemory(context->ChallengeMessage.pvBuffer, StartOffset, length);
+	if (context->ChallengeMessage.pvBuffer)
+		CopyMemory(context->ChallengeMessage.pvBuffer, Stream_Buffer(s) + StartOffset, length);
 #ifdef WITH_DEBUG_NTLM
 	WLog_DBG(TAG, "CHALLENGE_MESSAGE (length = %d)", length);
 	winpr_HexDump(TAG, WLOG_DEBUG, context->ChallengeMessage.pvBuffer,