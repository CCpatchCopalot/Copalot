diff --git a/src/podofo/main/PdfXRefStreamParserObject.cpp b/src/podofo/main/PdfXRefStreamParserObject.cpp
index 2cf9b79c4..1a5bce2a7 100644
--- a/src/podofo/main/PdfXRefStreamParserObject.cpp
+++ b/src/podofo/main/PdfXRefStreamParserObject.cpp
@@ -112,24 +112,24 @@ void PdfXRefStreamParserObject::parseStream(const int64_t wArray[W_ARRAY_SIZE],
     this->GetOrCreateStream().CopyTo(buffer);
 
     vector<int64_t>::const_iterator it = indices.begin();
-    char* cursor = buffer.data();
+    size_t offset = 0;
     while (it != indices.end())
     {
         int64_t firstObj = *it++;
         int64_t count = *it++;
 
+        if ((offset + count * entryLen) > buffer.size())
+            PODOFO_RAISE_ERROR_INFO(PdfErrorCode::InvalidXRefStream, "Invalid count in XRef stream");
+
         m_entries->Enlarge(firstObj + count);
         for (unsigned index = 0; index < (unsigned)count; index++)
         {
-            if ((size_t)(cursor - buffer.data()) >= buffer.size())
-                PODOFO_RAISE_ERROR_INFO(PdfErrorCode::NoXRef, "Invalid count in XRef stream");
-
             unsigned objIndex = (unsigned)firstObj + index;
             auto& entry = (*m_entries)[objIndex];
             if (objIndex < m_entries->GetSize() && !entry.Parsed)
-                readXRefStreamEntry(entry, cursor, wArray);
+                readXRefStreamEntry(entry, buffer.data() + offset, wArray);
 
-            cursor += entryLen;
+            offset += entryLen;
         }
     }
 }