

diff --git a/libtiff/tif_dir.c b/libtiff/tif_dir.c
index 9b153b63..1d8d306c 100644
--- a/libtiff/tif_dir.c
+++ b/libtiff/tif_dir.c
@@ -478,13 +478,13 @@ _TIFFVSetField(TIFF* tif, uint32_t tag, va_list ap)
 	case TIFFTAG_INKNAMES:
 		v = (uint16_t) va_arg(ap, uint16_vap);
 		s = va_arg(ap, char*);
-		v = checkInkNamesString(tif, v, s);
-		status = v > 0;
-		if( v > 0 ) {
+		ninksinstring = countInkNamesString(tif, v, s);
+		status = ninksinstring > 0;
+		if(ninksinstring > 0 ) {
 			_TIFFsetNString(&td->td_inknames, s, v);
 			td->td_inknameslen = v;
+			td->td_numberofinks = ninksinstring;
 			if (TIFFFieldSet(tif, FIELD_NUMBEROFINKS)) {
-				uint16_t ninks = td->td_numberofinks;
-				if (ninks != td->td_samplesperpixel) {
+				if (td->td_numberofinks != td->td_samplesperpixel) {
 					TIFFErrorExt(tif->tif_clientdata, module,
 					    "Bad value for \"NumberOfInks\" tag: %u, should be %u",
 					    ninks, td->td_samplesperpixel);